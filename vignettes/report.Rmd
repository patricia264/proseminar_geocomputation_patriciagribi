---
title: "report"
author: "Patricia Gribi"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document: default
  toc: yes
  toc_float: yes
  number_sections: yes
  latex_engine: xelatex
editor_options:
  markdown:
    wrap: 72
runtime: shiny
---

# 1. Introduction

From the 1950s, based on the Milankovic cycles, the aerosols in the
atmosphere and solar activity, stability or even cooling should commence
but the temperature curve is rising and it is getting warmer (IPCC
2007, p.5).

Compiling a time series enables an understanding of past environmental
conditions. For example, by integrating data from different environmental 
sources and applying different analytical techniques, the effects of climate 
change on past environments can be understood and insights into the evolution of 
species and communities can be gained.

The objective of this project is to create a seamless and consistent
timeline that effectively portrays historical temperature and CO2
variations. The primary goal is to answer what steps need to be taken to
construct a time-series and how the rate of change looks like.

By merging the different datasets, a holistic view is achieved that
extends beyond isolated short time-windows. Maintaining this data
consistency implies further advantages. Meaningful comparisons across
different time series can be conducted, facilitating in-depth analysis
and the identification of significant trends. Moreover, visualizations
of such time series make the data and also the research field more
accessible and insightful.


# 2. Methods and Data

The data sets utilized in this research project are primarily sourced
from the National Oceanic and Atmospheric Administration (NOAA). These
data sets are all tabular and come in either CSV or TXT format. The
age-scales vary as well as the resolution. The primary objective is to
create two distinct timelines: one representing CO2 concentrations and
the other displaying the temperature variations.

Linear interpolation was conducted to address instances of low
resolution within the data sets. The intention was to create a
consistent timeline for both CO2 and temperature data. Additionally,
overlapping sections of the data sets were identified and analyzed,
wether there are significant differences. In cases where a substantial
deviation was observed between the data sets, offsets were computed to
correct the timeline.

# 3. Data Wrangling

## 3.1 Overview

The data wrangling process began with the initial step of reading in the
data sets and loading the required libraries. Subsequently, the data sets
were reduced to retain only the essential variables: year, CO2 concentrations, 
and temperature. To ensure uniformity and comparability, the data sets were then 
standardized. This involved bringing all data sets to the same scale, resolution, 
and units. With the data sets homogenized, the analysis and the 
assembling of the timeline could take place.

## 3.2 Data-Reading and Loading Libraries

```{r, message=FALSE, warning=FALSE, echo=FALSE}

# reading co2 ice-core data

co2_ice_cores <- read.csv(paste0(here::here(),"/data/ice_cores_CO2_data.csv"), header = TRUE, sep = ";")

# reading co2 mauna-loa data
  
start_line <- 40
  
co2_mauna_loa <- read.csv(paste0(here::here(), "/data/co2_mm_mlo.csv"), skip = start_line, header = TRUE, sep = ",") 
  
# reading temp ice core 800KYr data
  
temp_800KYr <- read.csv(paste0(here::here(), "/data/temp_800_000.csv"), sep = "/", header = TRUE)
  
# reading temp pages2k data
  
temp_pages2k <- read.table(paste0(here::here(), "/data/temp_pages2k.txt"), header = TRUE, sep = "\t")
  
# reading temp NOAA data 
  
start_line <- 4
  
temp_NOAA_recentEra <- read.csv(paste0(here::here(), "/data/temp_NOAA_1850-2022.csv"), skip = start_line, header = TRUE, sep = ",")


# loading libraries

source("../R/load_libraries.R")

load_libraries()

```

## 3.3 Data Cleaning

### 3.3.1 Data Reduction

```{r, echo=FALSE}

# select only needed columns of the data-frames

# co2 data
  
co2_ice_cores <- select(co2_ice_cores, Gasage..yr.BP., CO2..ppmv.)

co2_mauna_loa <- select(co2_mauna_loa, year, month, average)

# temp data

temp_800KYr <- select(temp_800KYr, Age, Temperature)

temp_pages2k <- select(temp_pages2k, Year, Full.ensemble.median)

temp_NOAA_recentEra <- select(temp_NOAA_recentEra, Year, Anomaly)

```

### 3.3.2 Renaming of Variables

```{r, echo=FALSE}

# co2 data

colnames(co2_ice_cores) <- c("year", "co2")

colnames(co2_mauna_loa) <- c("year", "month", "co2")

# temp data

colnames(temp_800KYr) <- c("year", "temp")

colnames(temp_pages2k) <- c("year", "temp")

colnames(temp_NOAA_recentEra) <- c("year", "temp")

```

### 3.3.3 Format-Consistency

This research project aims to consistently represent the variables
across all data sets with the following conventions:

-   **Years:** Represented as a continuous scale with or without decimal
    values.
-   **CO2:** Represented in parts per million **(ppm)**.
-   **Temperature (temp):** Represented in degrees Celsius **(°C)**.

This standardization of variables enables to construction of a clear and
consistent timeline.


**CO2-Ice-Cores Data Set**

The first column of the ice-core-data is called "Gasage (yr BP)". The
"Gas Age" indicates how many years ago the gas sample was trapped within
the ice. "yr BP" represents the number of years before the year 1950. In
order to display the age as Gregorian calendar format the time-scale
needed to be converted. This was done by subtracting each row of the
data frame from 1950.

```{r, echo=FALSE}

# convert years before present to gregorian calendar

  for (i in seq_along(co2_ice_cores[,1])){
    
    # subtract 1950 from the data
    co2_ice_cores[i,1] <- 1950 - as.numeric(co2_ice_cores[i,1])
  }

```

The implemented conversion facilitates a comparative analysis of
distinct data sets. It will allow as well a later composition of the two
CO2-data-sets.

The age of the ice cores is expressed in decimal values, which reflects
the depth within the ice core. The retention of the decimals is
explained by the continuous nature of the time scale, signifying that
these measurements correspond to specific points within a year.

The CO2 trapped in the ice-cores is displayed in ppm (parts per million)
and was therefore in no need for conversion.


**CO2-Mauna-Loa Data Set**

In this data set, the temporal information is already represented in the
Gregorian-calendar format, spanning from 1958 to 2023. Due to the data
set's monthly resolution, the co2-values had to be aggregated to a
yearly scale. Furthermore the order had to be reorganized to begin with
the most recent year (2023).

The concentration of CO2 is expressed as a mole fraction, denoted in
parts per million (ppm). Consequently, the data set did not require any
conversion of its variables.

```{r, echo=FALSE}

# aggregate co2_mauna_loa to annual resolution and take average 

co2_mauna_loa <- co2_mauna_loa |>
  group_by(year) |>
  summarise(co2 = mean(co2))

# reverse order of data frame

co2_mauna_loa <- co2_mauna_loa %>% arrange(desc(co2_mauna_loa$year))

```


**Temp-NOAA-recent-Era Data Set**

Again, the temporal scale in this data set is structured in the desired
format. No further conversions had to be conducted.

The temperature values are displayed as anomalies. The absolute
reference temperature, derived from the period spanning from 1901 to
2000 quantified at 13.9°C (NOAA 2023), has been summed with each data
record.

```{r, echo=FALSE}

# conversion to absolute temperature

# reference temperature from 1901-2000 is 13.9°C

reference_temp <- 13.9

for (i in seq_along(temp_NOAA_recentEra[,2])){
 
    temp_NOAA_recentEra[i,2] <- reference_temp + as.numeric(temp_NOAA_recentEra[i,2])
    
}

```


**Temp-Pages2k Data Set**

The temporal scale in this data set is structured in the desired format,
leaving the necessity of any additional conversion.

The temperature values, are presented as anomalies relative to the
reference period spanning from 1961 to 1990, expressed in degrees
Celsius. To align with the absolute reference value of 14°C (United Nations 2016),
this constant value has been incrementally applied to each data set
record.

```{r, echo=FALSE}

# conversion to absolute temperature

# reference temperature from 1961-1990 is 14 degree Celsius

reference_temp <- 14

for (i in seq_along(temp_pages2k[,2])){
 
    temp_pages2k[i,2] <- reference_temp + as.numeric(temp_pages2k[i,2])
}

```


**Temp-800KYr Data Set**

This data set provides temperature records in degrees Celsius over a
800,000-year span. Like the co2-ice-core data set the age is represented
as years before present and therefore needed to be converted, in order
to display the age as Gregorian calendar-format. The age in this data
set expressed with decimal values.

```{r, echo=FALSE}

# convert years before present to gregorian calendar

  for (i in seq_along(temp_800KYr[,1])){
    
    # subtract 1950 from the data
    temp_800KYr[i,1] <- 1950 - as.numeric(temp_800KYr[i,1])
  }

```

The temperature is presented as a deviation from the mean observed over
the past 1000 years, which corresponds to an absolute value of -54.5
degree Celsius. Now the problem becomes evident, that the 800KYr data
set only displays local temperature changes in the Antarctica. However
the project aims to reconstruct a global time-series of temperature
data.

Because there were no other data sets found the 800KYr data set was
treated as if it would correspond to global temperatures. In practice
this would not be possible but in order to be able to perform this
time-series it was still done.

So first the absolute temperature reference period over the last 1'000
years was conducted by using the other two temperature data sets.

```{r, echo=FALSE}

# compute global absolute reference temperature over the past 1'000 years

reference_temp <- temp_NOAA_recentEra

reference_temp_subset <- temp_pages2k[temp_pages2k$year < 1850 & temp_pages2k$year >= 1000,]

reference_temp_subset <- reference_temp_subset %>% arrange(desc(reference_temp_subset$year))

reference_temp <- bind_rows(reference_temp, reference_temp_subset)

reference_temp <- mean(reference_temp$temp)

# add the reference temperature to the data

for (i in seq_along(temp_800KYr[,2])){
 
    temp_800KYr[i,2] <- reference_temp + as.numeric(temp_800KYr[i,2])
    
}

```

## 3.4 Construction of the Timelines

### 3.4.1 CO2-Timeline

In order to construct the co2-timeline out of the 2 provided data sets,
the focus has first been laid on the overlapping section. The plot below
shows the overlapping period, where both, co2-ice-core and
co2-mauna-loa, data are available.

```{r, warning = FALSE, echo=FALSE}

# plot of the two datasets

ggplot() +
  geom_line(data= co2_ice_cores, aes(x = year, y = co2, color = "Ice Cores"), size = 1) +
  geom_line(data = co2_mauna_loa, aes(x = year, y = co2, color = "Mauna Loa"), size = 1) +
  labs(title = "Overlapping Section of the co2-datasets",
       x = "Year",
       y = "CO2 Concentration in ppm") +
  scale_color_manual(values = c("Ice Cores" = "cornflowerblue", "Mauna Loa" = "coral"),
                     name = "Datasources") +
  xlim(1957, 2023) +
  ylim(300,425) +
  theme_minimal()

```


**Description:**

The two data sets have a relatively consistent correspondence. The
co2-ice-cores data set contains stronger fluctuations. Also there are
more data points lying below the co2-mauna-loa data set than above it.
Around the year 1980, the co2-ice-cores data set consistently registers
lower concentrations of carbon dioxide (CO2) in comparison to the
co2-mauna-loa data set. Moreover, the two lines do not intersect
anymore.


**Analysis:**

The illustration above provides a very good initial overview of the
situation.

In contrast to the mauna-loa data set, the ice-cores data set lacks a
consistent, annual resolution. Within a single year, there may be 2-3
measurements or there are gaps extending over several years. During the
overlapping period less ice-cores data is available. Furthermore, the
data is derived from direct measurements and, unlike the mauna-loa data
set, is not averaged. These two factors may explain the rougher curve
observed in the ice-cores data set.

In order to be able to determine the further procedure for creating the
time series, it should be seen whether the two data sets show a
significant difference regarding their CO2 values during the overlapping
period.

To do this the mean over all data points of the overlapping period
should be conducted for the two data sets.

Before doing so, the co2-ice-cores data set had to be brought to an
annual resolution to compute the mean over the same amount of data
points. Overall it was noticed, that the co2-ice-cores data set has
data-gaps over 50 years, especially as the age gets older (around
-100'000 years).

```{r, echo=FALSE}

# check for gaps larger than 50 years
time_diff <- abs(diff(co2_ice_cores$year))
max_gap_allowed <- 50

# check if all differences are less than or equal to 10
no_large_gaps <- all(time_diff <= max_gap_allowed)

# print of the result
if (no_large_gaps) {
  cat("There are no larger gaps than", max_gap_allowed, "years.\n")
} else {
  cat("There are larger gaps than", max_gap_allowed, "years.\n")
}

```

A linear interpolation was conducted to gain the annual resolution of
the co2-ice-cores data set.

```{r, echo=FALSE}

# aggregate ice-cores data set to years

agg_ice_cores <- co2_ice_cores %>%
  group_by(year = as.numeric(substring(year, 1, regexpr("\\.", year)))) %>%
  summarize(co2 = mean(co2))

agg_ice_cores <- agg_ice_cores %>% arrange(desc(agg_ice_cores$year))
agg_ice_cores <- na.omit(agg_ice_cores)

# compute linear interpolation

interpolated_df <- data.frame(
  # sequence with annual resolution
  year = seq(min(agg_ice_cores$year, na.rm = TRUE), max(agg_ice_cores$year, na.rm = TRUE), by = 1)  
)

interpolated_df$co2 <- approx(x = agg_ice_cores$year, y = agg_ice_cores$co2, xout = interpolated_df$year)$y

```

The plot below now shows the interpolated co2-ice-cores data set
together with the unchanged co2-mauna-loa data set. It can be seen that
the co2-ice-cores curve is much smoother and therefore shows fewer
strong fluctuations.

```{r, warning = FALSE, echo=FALSE}

# plot of the two datasets

ggplot() +
  geom_line(data= interpolated_df, aes(x = year, y = co2, color = "Ice Cores"), size = 1) +
  geom_line(data = co2_mauna_loa, aes(x = year, y = co2, color = "Mauna Loa"), size = 1) +
  labs(title = "CO2 Values Over Time",
       x = "Year",
       y = "CO2 Concentration in ppm") +
  scale_color_manual(values = c("Ice Cores" = "cornflowerblue", "Mauna Loa" = "coral"),
                     name = "Datasources") +
  xlim(1957, 2023) +
  ylim(300,425) +
  theme_minimal()

```

Finally, the mean of the overlap period of both data sets could be
determined. They were then subtracted from each other and formed the
so-called offset. The t-test was carried out to find out whether the
difference between the two is significant.

```{r, echo=FALSE}

# subsets of the overlapping period of co2_ice_cores and co2_mauna_loa data sets

subset_mauna_loa <- co2_mauna_loa[co2_mauna_loa$year <= 2001,]

subset_ice_cores <- interpolated_df[interpolated_df$year >= 1958,]

# calculate the means of both subsets

mean_mauna_loa <- mean(subset_mauna_loa$co2)

mean_ice_cores <- mean(subset_ice_cores$co2)

# calculate the offset

offset <- mean_mauna_loa - mean_ice_cores

# make a t-test to see if means have a significant difference

t_test_result <- t.test(subset_mauna_loa$co2, subset_ice_cores$co2)

print(t_test_result)

```

The t-test was conducted to see if there is a significant difference
between the means of the two data sets. The null-hypothesis says in this
case, that the two data-sets have no significant difference. The p-value
is xxx lies within the acceptance region. The null-hypothesis must
therefore be accepted and cannot be rejected. Consequently the two data
sets show no significant difference during the overlap period. Based on
this result, the offset will not be added to the ice-core-data-set and
no "correction" will be performed.


**Discussion:**

To construct the final timeline no offset is applied to the
co2-ice-cores data as already discussed. The interpolated values on the
other hand are adopted. Starting from the overlapping period, the
co2-mauna-loa data set is chosen. This decision is motivated by the
availability of more precise and up-to-date data, facilitated by direct
measurements of atmospheric CO2 concentrations. Unlike ice-core
extractions, which require a more complex process, measuring CO2
directly from the atmosphere provides a more accurate representation of
current conditions.

**The CO2-timeline**

```{r, collapse=TRUE}

# plot

# select mauna-loa dataset

co2_timeline <- co2_mauna_loa

# add ice-core data from 1958 on

subset_interpolated_df <- interpolated_df[interpolated_df$year < 1958,]

subset_interpolated_df <- subset_interpolated_df %>% arrange(desc(subset_interpolated_df$year))

co2_timeline <- bind_rows(co2_timeline, subset_interpolated_df)


# plot

ggplot(data = co2_timeline) +
  geom_line(aes(x = year, y = co2), size = 1) +
  labs(title = "CO2-Timeline",
       x = "Year",
       y = "CO2 [ppm]") +
  scale_x_continuous(labels = label_comma()) + 
  theme_minimal()

```

The CO2 time series exhibits significant and regular fluctuations over a
span of 50,000 years. The range varies between 150 (minimum) and 300
(maximum). However, in the latter part of the time series, a pronounced
increase is evident, surpassing all other fluctuations by a considerable
margin, reaching levels exceeding 400 ppm (parts per million)

#### Further Analysis

**Rate of Change**

To further quantify the CO2 curve, the rate of change of the CO2 time
series was examined. As inferred from the above plot, the most
substantial rates of change are observed in recent years (see figure
below).

```{r, echo=FALSE, warning=FALSE}

time_period <- 1

# calculate rate of change over certain time_period
co2_timeline$rate_of_change <- c(rep(NA, time_period), 
                                diff(co2_timeline$co2, lag = time_period) / diff(co2_timeline$year, lag = time_period))

# index of the highest rate of change
max_rate_index <- which.max(co2_timeline$rate_of_change)


# year with the highest rate of change
year_of_max_rate <- co2_timeline$year[max_rate_index]

# highest rate of change over given time_period
max_rate <- co2_timeline$rate_of_change[max_rate_index]

# results
cat("Time period with highest rate of change:", year_of_max_rate, "\n")
cat("Highest rate of change:", max_rate, "\n")


# plot 
ggplot(co2_timeline, aes(x = year, y = rate_of_change)) +
  geom_line() +
  geom_point() +
  labs(title = "Rate of Change of the CO2-Concentration",
       x = "Year",
       y = "Rate of Change") +
  scale_x_continuous(labels = label_comma()) +
  xlim(1000, 2023) +
  theme_minimal()

```

```{r, warning=FALSE, echo=FALSE}

quadmod <- lm(co2 ~ poly(year, 2), data = co2_timeline )
summary(quadmod)

quadmod <- lm(co2 ~ poly(year, 3), data = co2_timeline )

quadmod <- lm(co2 ~ poly(year, 4), data = co2_timeline )

# plot

co2_timeline |>
  ggplot(aes(x = year, y = co2)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = "lm", aes(color = "lm"), se = FALSE) +
  geom_smooth(formula = y ~ poly(x, 2), method = "lm", 
              aes(color = "poly2"), se = FALSE) +
  geom_smooth(formula = y ~ poly(x, 3), method = "lm", 
              aes(color = "poly3"), se = FALSE) +
  geom_smooth(formula = y ~ poly(x, 4), method = "lm", 
              aes(color = "poly4"), se = FALSE) +
  labs(x = "year", y = "co2 [ppm]", color = "Regression") +
   scale_x_continuous(labels = label_comma()) +
  xlim(1000,2023) + 
  theme_minimal()

```

The higher the polynomial, the better the modeled curve matches the
actual data.

### 3.4.2 Construction of the Temperature Timeline

Also here the initial step involved in the generation of the temperature
timeline was the observation of the temporal intersection among the
three data sets. This emphasis is directed to facilitate the combination
of the temporal components.

```{r, warning = FALSE, echo=FALSE}

# plot of another excerpt of the datasets 

ggplot() +
  geom_line(data= temp_pages2k, aes(x = year, y = temp, color = "Temp_pages2K"), size = 1) +
  geom_line(data = temp_NOAA_recentEra, aes(x = year, y = temp, color = "Temp_NOAA_recentEra"), size = 1) +
  geom_line(data = temp_800KYr, aes(x = year, y = temp, color = "Temp_800_KYr"), size = 1) +
  labs(title = "Temperature Over Time",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_color_manual(values = c("Temp_pages2K" = "yellowgreen", "Temp_NOAA_recentEra" = "coral", "Temp_800_KYr" = "cornflowerblue"), name = "Datasources") +
  xlim(-1, 1912) +
  ylim(11,18) +
  theme_minimal()

```

**Description:**

The blue curve exhibits pronounced fluctuations with a considerably
larger range of temperature values. In contrast, the green and orange
data sets demonstrate a significantly closer proximity. The initial
focus is directed toward the green and orange data sets, as their
similarity seems very high.

```{r, warning = FALSE, echo=FALSE}

# plot of the overlapping section of the 3 temperature datasets

ggplot() +
  geom_line(data= temp_pages2k, aes(x = year, y = temp, color = "Temp_pages2K"), size = 1) +
  geom_line(data = temp_NOAA_recentEra, aes(x = year, y = temp, color = "Temp_NOAA_recentEra"), size = 1) +
  labs(title = "Temperature Over Time",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_color_manual(values = c("Temp_pages2K" = "yellowgreen", "Temp_NOAA_recentEra" = "coral"), name = "Datasources") +
  xlim(1849, 2001) +
  ylim(13,15) +
  theme_minimal()

```

The orange and green curves exhibit nearly identical fluctuations,
showing a very high similarity. During the interval spanning from 1850
to approximately 1880, the NOAA_recentEra data set exhibits slight
higher temperature values in comparison to the pages2k. However, this
difference is recognizable due to the small temperature-scale on the
y-axis. The temperature variance is mere than 0.25 degrees Celsius.

**Analysis:**

Both data sets have a consistent annual resolution. Their reference
temperature varies only by 0.1°C. Although they are from different
sources, they correspond very well. In order to quantify whether the two
data sets are significantly different or not, the t-test was reapplied.

```{r, echo=FALSE}

# subsets of the overlapping period of temp_NOAA_recenEra and temp_pages2k data sets

subset_NOAA_recentEra <- temp_NOAA_recentEra[temp_NOAA_recentEra$year <= 2000,]

subset_pages2k <- temp_pages2k[temp_pages2k$year >= 1850,]

# omit NA-values

subset_pages2k <- na.omit(subset_pages2k)


# calculate the means of both subsets

mean_NOAA_recentEra <- mean(subset_NOAA_recentEra$temp)

mean_pages2k <- mean(subset_pages2k$temp)


# calculate the offset

offset <- mean_NOAA_recentEra - mean_pages2k

# make a t-test to see if means have a significant difference

t_test_result <- t.test(subset_NOAA_recentEra$temp, subset_pages2k$temp)

print(t_test_result)

```

The null-hypothesis states, that the two data-sets have no significant
difference. The p-value is 0.31 and lies as well within the acceptance
region. The null-hypothesis must therefore be accepted and cannot be
rejected. The NOAA_recentEra and the pages2k data sets do not reveal a
significant difference during their overlapping period.

The findings indicate that the choice of the data set is irrelevant, as
statistical significant distinctions between them are lacking. They
basically do not differ.

The NOAA_recentEra data set comprises direct measurements obtained from
meteorological stations globally, in contrast to the temp_Pages2k data
set, which relies on diverse global proxies. Consequently, the initial
segment of the temperature timeline will be derived from the
NOAA_recentEra data set, followed by the subsequent integration of the
Temp_Pages2k data set.

**1. Part of the Temperature Timeline**

```{r, echo=FALSE}

# select NOAA_recentEra data set

temp_timeline <- temp_NOAA_recentEra

temp_timeline <- temp_timeline %>% arrange(desc(temp_timeline$year))

# add pages2k data from 1850 on

timeline_subset_pages2k <- temp_pages2k[temp_pages2k$year < 1850,]

timeline_subset_pages2k <- timeline_subset_pages2k %>% arrange(desc(timeline_subset_pages2k$year))

temp_timeline <- bind_rows(temp_timeline, timeline_subset_pages2k)


# plot

ggplot(data = temp_timeline) +
  geom_line(aes(x = year, y = temp), size = 1) +
  labs(title = "Temperature Timeline",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_x_continuous(labels = label_comma()) + 
  theme_minimal()

```

**Addition of the 800_KYr data**

The next step is to connect the 3rd, temp_800KYr, data set. Like
previously with the CO2 data, the first step was to check whether the
data set had large gaps. As this was the case (see code below), a linear
interpolation was applied once more.

```{r, echo=FALSE}

# check for gaps larger than 50 years
time_diff <- abs(diff(temp_800KYr$year))
max_gap_allowed <- 50

# check if all differences are less than or equal to 10
no_large_gaps <- all(time_diff <= max_gap_allowed)

# print of the result
if (no_large_gaps) {
  cat("There are no larger gaps than", max_gap_allowed, "years.\n")
} else {
  cat("There are larger gaps than", max_gap_allowed, "years.\n")
}

```

```{r, echo=FALSE}

duplicates <- duplicated(temp_800KYr$year)

# display rows with duplicate values
if (any(duplicates)) {
  duplicated_rows <- temp_800KYr[duplicates, ]
  print("Duplicates found:")
  print(duplicated_rows)
} else {
  print("No duplicates found.")
}


for (i in seq_along(temp_800KYr[,1])){
    
    # cut the decimals values
    temp_800KYr[i,1] <- floor(as.numeric(temp_800KYr[i,1]))
}


# compute linear interpolation

interpolated_800KYr <- data.frame(
  # sequence with annual resolution
  year = seq(min(temp_800KYr$year, na.rm = TRUE), max(temp_800KYr$year, na.rm = TRUE), by = 1)  
)

interpolated_800KYr$temp <- approx(x = temp_800KYr$year, y = temp_800KYr$temp, xout = interpolated_800KYr$year)$y

# rearrange
interpolated_800KYr <- interpolated_800KYr %>% arrange(desc(interpolated_800KYr$year))
interpolated_800KYr <- na.omit(interpolated_800KYr)

```

Below, the interpolated data-set is plotted together with the already
computed temperature timeline consisting of the other two data sets.

```{r, warning = FALSE, echo=FALSE}

# plot of the two datasets

ggplot() +
  geom_line(data= interpolated_800KYr, aes(x = year, y = temp, color = "800KYr"), size = 1) +
  geom_line(data = temp_timeline, aes(x = year, y = temp, color = "Temp-Timeline"), size = 1) +
  labs(title = "Temperature Over Time",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_color_manual(values = c("800KYr" = "cornflowerblue", "Temp-Timeline" = "coral"),
                     name = "Datasources") +
  xlim(-1000, 2023) +
  ylim(10,18) +
  theme_minimal()

```

The blue data set still shows higher fluctuations than the temperature
timeline. To correct the blue data set to some degree, the mean of both
curves was calculated over the overlapping period. The difference was
then applied as an offset to the 800KYr data.

```{r, echo=FALSE}

# subsets of the overlapping period of 800KYr and temp_timeline

subset_800KYr <- interpolated_800KYr[interpolated_800KYr$year > 0,]

subset_temp_timeline <- temp_timeline[temp_timeline$year <= 1911,]

# calculate the means of both subsets

mean_800KYr <- mean(subset_800KYr$temp)

mean_temp_timeline <- mean(subset_temp_timeline$temp)

# calculate the offset

offset <- mean_temp_timeline - mean_800KYr

# make a t-test to see if means have a significant difference

t_test_result <- t.test(subset_800KYr$temp, subset_temp_timeline$temp)

print(t_test_result)

```

The p-value of the t-test is here very small and lies within the
rejection-region of the null-hypothesis. There is indeed a significant
difference between the overlapping secton of the two curves
(temp-timeline and temp_800KYr).

```{r, warning=FALSE, echo=FALSE}

# subtract offset

interpolated_800KYr$temp <- interpolated_800KYr$temp + offset

# plot

ggplot() +
  geom_line(data= interpolated_800KYr, aes(x = year, y = temp, color = "800KYr"), size = 1) +
  geom_line(data = temp_timeline, aes(x = year, y = temp, color = "Temp-Timeline"), size = 1) +
  labs(title = "Temperature Over Time",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_color_manual(values = c("800KYr" = "cornflowerblue", "Temp-Timeline" = "coral"),
                     name = "Datasources") +
  xlim(-1000, 2023) +
  ylim(10,18) +
  theme_minimal()

```

Despite interpolation and offset correction, the blue curve still shows
stronger fluctuations than the orange curve.

**Discussion**

The observed higher fluctuations in the 800KYr data set may be
attributed to the increased sensitivity of temperature fluctuations in
Antarctica.

Another reason for the higher fluctuations could be explained also due
to higher measurement uncertainities in ice-core samples. The
temp_pages2K data set on the other hand, incorporates multiple proxies
from 692 records across 648 locations, encompassing continental regions
and major ocean basins. These records derive from various sources,
including trees, ice, sediment, corals, speleothems, documentary
evidence, and other archives. The data in this set is "averaged," resulting in 
less pronounced fluctuations. The NOAA-recentEra data set is presumed to be the 
most accurate, given its reliance on direct atmospheric temperature measurements.

Considering that the blue curve represents local temperature values with
inherently less precise data compared to the other two data sets, the
temp_800KYr data set is appended to the existing temperature curve. This
decision is made in recognition of the localized and less accurate
nature of the blue curve, while emphasizing the integration of the
800KYr data set into the overall temperature trend.


**Complete Temperature Timeline**

The plot below shows the full constructed temperature timeline.

```{r, warning=FALSE, echo=FALSE}

# add 800KYr data from 0 on

timeline_subset_800KYr <- interpolated_800KYr[interpolated_800KYr$year <= 0,]

timeline_subset_800KYr <- timeline_subset_800KYr %>% arrange(desc(timeline_subset_800KYr$year))

temp_timeline <- bind_rows(temp_timeline, timeline_subset_800KYr)

# plot

ggplot(data = temp_timeline) +
  geom_line(aes(x = year, y = temp), size = 1) +
  labs(title = "Temperature Timeline",
       x = "Year",
       y = "Temperature [degree Celsius]") +
  scale_x_continuous(labels = label_comma()) +
  theme_minimal()

```

#### Further Analysis

**Rate of Change**

Also the rate of change of the temperature-curve was analyized. The
result is not as clearly as in the co2-timeline. The rates of change
show no pattern but alternate strongly.

```{r, warning=FALSE, echo=FALSE, message=FALSE}

time_period <- 1

# calculate rate of change over certain time_period
temp_timeline$rate_of_change <- c(rep(NA, time_period), 
                                diff(temp_timeline$temp, lag = time_period) / diff(temp_timeline$year, lag = time_period))

# index of the highest rate of change
max_rate_index <- which.max(temp_timeline$rate_of_change)


# year with the highest rate of change
year_of_max_rate <- temp_timeline$year[max_rate_index]

# highest rate of change over given time_period
max_rate <- temp_timeline$rate_of_change[max_rate_index]

# results
cat("Time period with highest rate of change:", year_of_max_rate, "\n")
cat("Highest rate of change:", max_rate, "\n")


# plot 
ggplot(temp_timeline, aes(x = year, y = rate_of_change)) +
  geom_line() +
  geom_point() +
  labs(title = "Rate of Change of the CO2-Concentration",
       x = "Year",
       y = "Rate of Change") +
  scale_x_continuous(labels = label_comma()) +
  xlim(1500, 2023) +
  theme_minimal()



```

# 4. Results


On the figure below, the entire generated CO2 and temperature time series is 
now visible. A slider allows for the selection of any time interval. Once again, 
the various large and regular fluctuations are evident, and from the beginning 
of the Industrialization, a clear and drastic increase becomes apparent.

```{r, echo=FALSE}

# merge temperature and co2 timeline

comb_timeline <- merge(temp_timeline, co2_timeline, by = "year", all = TRUE)

# transform temp to co2 range to retransform in ggplot with trans

mean_comb_timeline <- mean(comb_timeline$temp, na.rm = TRUE)

mean_comb_co2 <- mean(comb_timeline$co2, na.rm = TRUE)

x <- mean_comb_co2 / mean_comb_timeline

comb_timeline$temp <- comb_timeline$temp * x

y <- mean_comb_timeline / mean_comb_co2


# Shiny app structure
ui <- fluidPage(
  sliderInput("time_range", "Select Time Range",
              min = min(comb_timeline$year),
              max = max(comb_timeline$year),
              value = c(min(comb_timeline$year), max(comb_timeline$year)),
              step = 10,
              ticks = TRUE,
              round = TRUE,),
  
  textInput("custom_range", "Enter Time Range (e.g., 2000,2010)", ""),
  
  plotOutput("timeline_plot")
)

server <- function(input, output) {
  # Function to create a subset of data based on the slider and text input
  filtered_data <- reactive({
    min_year <- if (input$custom_range != "") as.numeric(strsplit(input$custom_range, ",")[[1]][1]) else input$time_range[1]
    max_year <- if (input$custom_range != "") as.numeric(strsplit(input$custom_range, ",")[[1]][2]) else input$time_range[2]

    subset(comb_timeline, year >= min_year & year <= max_year)
  })

  output$timeline_plot <- renderPlot({
    ggplot() +
      geom_line(data = filtered_data(), aes(x = year, y = co2), size = 1, color = "cornflowerblue") +
      geom_line(data = filtered_data(), aes(x = year, y = temp), size = 1, color = "coral") +
      labs(title = "CO2 and Temperature Timeline",
           x = "Year",
           y = "CO2 Concentration [ppm]",
           color = "Legend") +
      scale_x_continuous(labels = scales::label_comma()) + 
      scale_y_continuous(name = "CO2 Concentration [ppm]") +
      scale_y_continuous(sec.axis = sec_axis(trans = ~.*y, name = "Temperature [°C]",
                                            breaks = seq(0, 15, by = 5), labels = seq(0, 15, by = 5))) +
      theme_minimal() +
      theme(plot.title = element_text(size = 20),
            plot.margin = margin(t = 10),
            axis.text.x = element_text(margin = margin(b = 10), face = "bold"),
            axis.text.y = element_text(face = "bold"))
  })
  
  onStop(function() {
    stopApp()
  })
  
}

shinyApp(ui, server)

```



# 5. Discussion


The objective of this project was to create a timeline that effectively portrays
historical temperature and CO2 variations. The primary goal was to answer what 
steps need to be taken to construct a time-series and how the rate of change 
looks like.

The results of this project have its limitations, primarily originating from the 
local ice-core data. While this data provides valuable insights into the local 
paleoenvironment, there are constraints associated with the reconstruction of 
the global atmospheric temperature. Changes in the atmospheric temperature
may have been very different in other parts of the globe than in Antarctica. 
For example the sea surface temperature remarked its biggest changes in the polar
regions (Prell 1985).

During the data-research the majority of the proxies in studies measured paleo 
sea surface temperatures, which was not the target in this project.

In terms of reliance direct measurements obviously remain the gold standard. 
However, they are often limited by temporal constraints and the unavailability 
of historical data. To overcome these limitations, other data originating from 
different archives had to be employed. As already mentioned ice-core-data was
adopted in spite of their limitations. The temp_pages2k data set was very 
favourable in terms of reliance, as it consists of measurements of many
different proxies from various archives. As a result, that this data set 
corresponded extremely well with the direct measured data.

Despite the limitations, the two time series provide an overview of the variables 
temperature and CO2. It is particularly interesting to observe how, beginning from 
the industrialization on the values increase remarkably. In the CO2 series, this 
change is also drastically demonstrated in the rate of change. In the last few 
decades, she has increased significantly. This cannot (yet) be seen in the 
temperature records. Presumably, the temperature is a slower target and therefore 
a lagging indicator. Overall, the two time series once more confirm the influence 
of humans on the environment.

The reconstruction of Earth's paleo-environmental conditions is essential for 
contextualizing current climatic trends. By examining historical records, it can
be emphasized that while natural fluctuations have been common in the Earth's 
climate system, the present trajectory indicates a deviation of unparalleled 
magnitude. The findings in this project point out once more the urgency of 
addressing anthropogenic contributions to environmental changes.

A key objective to extend this project could be to enhance the reliability of 
the timelines by sourcing additional co2- and temperature data measured in
diverse archives and proxies. This would provide a more comprehensive and robust 
historical perspective on Earth's climatic evolution.

Furthermore, the scope and understanding of paleo-climatic conditions could be 
broaden by incorporating more environmental variables. And taking the project 
even a step further would involve the modeling of the variables (temperature and
co2) acquired. 

# 6. Conclusion

According to the IPCC report from 2007, we should be experiencing a stagnation 
in temperatures (IPPC 2007, p.5). However, this research project demonstrates
like many others before that this is not the case. The CO2 curve exceeds levels 
not experienced in the past 800,000 years since the beginning of industrialization. 
The temperature trend is not as pronounced but a warming trend is also evident.

This is recognizable from the time series created in this project. To accurately 
represent a time series of environmental variables, various considerations must 
be taken into account. The selection of data, standardization, and seamless 
integration are essential steps to achieve a meaningful and satisfactory result.



# References

- Bereiter Bernhard, Eggleston Sarah, Schmitt Jochen, Nehrbass-Ahles Christoph, F. Stocker Thomas, Fischer Hubertus, Kipfstuhl Sepp, Chappellaz Jerome (2014): Revision of the EPICA Dome C CO2 record from 800 to 600 kyr before present. In: Geophysical Research Letters, 2015, Vol. 42, Issue 2. DOI: https://doi.org/10.1002/2014GL061957
- Jouzel, J., V. Masson-Delmotte, O. Cattani, G. Dreyfus, S. Falourd, G. Hoffmann, B. Minster, J. Nouet, J.M. Barnola, J. Chappellaz, H. Fischer, J.C. Gallet, S. Johnsen, M. Leuenberger, L. Loulergue, D. Luethi, H. Oerter, F. Parrenin, G. Raisbeck, D. Raynaud, A. Schilt, J. Schwander, E. Selmo, R. Souchez, R. Spahni, B. Stauffer, J.P. Steffensen, B. Stenni, T.F. Stocker, J.L. Tison, M. Werner, and E.W. Wolff (2007): Orbital and Millennial Antarctic Climate Variability over the Past 800,000 Years. In: Science, Vol. 317, No. 5839, pp.793-797, 10 August 2007.
- Lan, X., Tans, P. and K.W. Thoning: Trends in globally-averaged CO2 determined from NOAA Global Monitoring Laboratory measurements. Version 2023-10. https://doi.org/10.15138/9N0H-ZH07
- Neukom Raphael, Barboza Luis A., Erb Michael P., Shi Feng, Emile-Geay Julien, Evans Michael N., Franke Jörg, Kaufman Darrell S., Lücke Lucie, Rehfeld Kira, Schurer Andrew, Zhu Feng, Brönnimann Stefan, Hakim Gregory J., Henley Benjamin J., Charpentier Ljungqvist Fredrik, McKay Nicholas, Valler Veronika, von Gunten Lucien (2019): Consistent multidecadal variability in global temperature reconstructions and simulations over the Common Era. In: Nature Geoscience, PAGES2k Consortium 2019, Vol. 12. DOI: https://doi.org/10.6084/m9.figshare.c.4507043.v2 
- NOAA National Centers for Environmental Information (2023): Climate at a Glance Global Time Series. https://www.ncei.noaa.gov/access/monitoring/climate-at-a-glance/global/time-series (published October 2023) (retrieved on November 2, 2023) 
- NOAA National Centers for Environmental Information (2023): Climate at a Glance Global Time Series.
https://www.ncei.noaa.gov/access/monitoring/monthly-report/global/202013 (published October 2023)
(retrieved on November 5, 2023)
- Pachauri, R.K, Reisinger, A. (eds.) (2007): Climate Change 2007. Synthesis Report. Contribution of Working Groups I, II and III to the Fourth Assessment Report of the Intergovernmental Panel on Climate Change. IPCC, Geneva, Switzerland, 104 pp.
- Prell, W.L. (1985): The stability of low-latitude sea-surface temperatures. An evaluation of the 
CLIMAP reconstruction with emphasis on the positive SST anomalies. Washington, D. C., 
Department of Energy, 60p.
- United Nations (2016): Sustainable Development Goals. WMO confirms 2015 as hottest year on record. https://www.un.org/sustainabledevelopment/blog/2016/01/wmo-confirms-2015-as-hottest-year-on-record/ (published on January 25, 2016) (retrieved on November 5, 2023)


