---
title: "Data Wrangling"
author: "Patricia Gribi"
date: "2023-10-02"
output:
  pdf_document: default
  html_document: default
editor_options:
  markdown:
    wrap: 72
---

# Introduction


TODO

Gives the background, explains the relevance, and motivates the
(research) question. The introduction may also motivate the
methodological approach, but doesn't give its details.

Background: Briefly introduce the broader context of your project.
Highlight the significance of studying the relationship between CO2 and
temperature data. Motivation: Clearly state the research question or
objective. Explain why investigating this question is important.


# Methods and Data


The data sets utilized in this research project are primarily sourced from the 
National Oceanic and Atmospheric Administration (NOAA). These data sets are all
tabular and come in either CSV or TXT format. The age-scales vary as well as the
resolution. The primary objective is to create two distinct timelines: one 
representing CO2 concentrations and the other displaying the temperature 
variations.

Linear interpolation was conducted to address instances of low resolution within 
the data sets. The intention was to create a consistent timeline for both CO2 and 
temperature data. Additionally, overlapping sections of the data sets were 
identified and analyzed, wether there are significant differences. In cases where 
a substantial deviation was observed between the data sets, offsets were computed 
to correct the timeline.


# Data Wrangling


## Overview


The data wrangling process began with the initial step of reading in the data
sets and loading the required libraries. Subsequently, the data were reduced 
to retain only the essential variables: year, CO2 concentrations, and temperature.
To ensure uniformity and comparability, the data sets were then standardized. 
This involved bringing all data sets to the same scale, resolution, and units.
With the data sets now homogenized, then the analysis and the assembling of the 
timeline could take place.


## Data-Reading & Loading Libraries

```{r, collapse = TRUE, message = FALSE, warning = FALSE}

# reading co2 ice-core data

co2_ice_cores <- read.csv(paste0(here::here(),"/data/ice_cores_CO2_data.csv"), header = TRUE, sep = ";")

# reading co2 mauna-loa data

start_line <- 40

co2_mauna_loa <- read.csv(paste0(here::here(), "/data/co2_mm_mlo.csv"), skip = start_line, header = TRUE, sep = ",") 

# reading temp ice core 800KYr data

temp_800KYr <- read.csv(paste0(here::here(), "/data/temp_800_000.csv"), sep = "/", header = TRUE)

# reading temp pages2k data

temp_pages2k <- read.table(paste0(here::here(), "/data/temp_pages2k.txt"), header = TRUE, sep = "\t")

# reading temp NOAA data 

start_line <- 4

temp_NOAA_recentEra <- read.csv(paste0(here::here(), "/data/temp_NOAA_1850-2022.csv"), skip = start_line, header = TRUE, sep = ",")

# loading needed libraries

library(tidyverse)

library(lubridate)

library(dplyr)

library(ggplot2)

library(scales)

library(htmltools)

library(rmarkdown)

library(kableExtra)

library(fastmap)

library(shiny)

```

## Data Cleaning

### Data Reduction

```{r, collapse = TRUE}

# select only needed columns of the data-frames

# co2 data

co2_ice_cores <- select(co2_ice_cores, Gasage..yr.BP., CO2..ppmv.)

co2_mauna_loa <- select(co2_mauna_loa, year, month, average)

# temp data

temp_800KYr <- select(temp_800KYr, Age, Temperature)

temp_pages2k <- select(temp_pages2k, Year, Full.ensemble.median)

temp_NOAA_recentEra <- select(temp_NOAA_recentEra, Year, Anomaly)

```

### Format-Consistency

This research project aims to consistently represent the variables
across all datasets with the following conventions:

-   **Years:** Represented as a continuous scale with or without decimal
    values.
-   **CO2:** Represented in parts per million **(ppm)**.
-   **Temperature (temp):** Represented in degrees Celsius **(°C)**.

This standardization of variables enables to construction of a clear and
consistent timeline.


**CO2-Ice-Cores Data Set**

The first column of the ice-core-data is called "Gasage (yr BP)". The
"Gas Age" indicates how many years ago the gas sample was trapped within
the ice. "yr BP" represents the number of years before the year 1950. In
order to display the age as Gregorian calendar format the time-scale
needed to be converted. This was done by subtracting each row of the
data frame from 1950.

```{r, collapse= TRUE}

# convert years before present to gregorian calendar

  for (i in seq_along(co2_ice_cores[,1])){
    
    # subtract 1950 from the data
    co2_ice_cores[i,1] <- 1950 - as.numeric(co2_ice_cores[i,1])
  }

```

The implemented conversion facilitates a comparative analysis of
distinct data sets. It will allow as well a later composition of the two
CO2-data-sets.

The age of the ice cores is expressed in decimal values, which reflects
the depth within the ice core. The retention of the decimals is
explained by the continuous nature of the time scale, signifying that
these measurements correspond to specific points within a year.

The CO2 trapped in the ice-cores is displayed in ppm (parts per million)
and was therefore in no need for conversion.


**CO2-Mauna-Loa Data Set**

In this data set, the temporal information is already represented in the
Gregorian-calendar format, spanning from 1958 to 2023. Due to the
data set's monthly resolution, the co2-values had to be aggregated to a
yearly scale. Furthermore the order had to be reorganized to begin with
the most recent year (2023).

The concentration of CO2 is expressed as a mole fraction, denoted in
parts per million (ppm). Consequently, the data set did not require any
conversion of its variables.


```{r}

# aggregate co2_mauna_loa to annual resolution and take average 

co2_mauna_loa <- co2_mauna_loa |>
  group_by(year) |>
  summarise(average = mean(average))

# reverse order of data frame

co2_mauna_loa <- co2_mauna_loa %>% arrange(desc(co2_mauna_loa$year))

```


**Temp-800KYr Data Set**

This data set provides temperature records in degrees Celsius over a
800,000-year span. Like the co2-ice-core data set the age is represented
as years before present and therefore needed to be converted, in order
to display the age as Gregorian calendar-format.

The age in this data set is expressed too with decimal values.


```{r, collapse=TRUE}

# convert years before present to gregorian calendar

  for (i in seq_along(temp_800KYr[,1])){
    
    # subtract 1950 from the data
    temp_800KYr[i,1] <- 1950 - as.numeric(temp_800KYr[i,1])
  }

```


The temperature is presented as a deviation from the mean observed over
the past 1000 years. ~ -54.5degC

This corresponds to an absolute value of 13.8°C
(Quelle). Accordingly, the current temperature value in the data set was
augmented by 13.8 to yield the adjusted representation.


```{r}

# conversion to absolute temperature

# reference temperature from 1901-2000 is 13.8°C

reference_temp <- 13.8

for (i in seq_along(temp_800KYr[,2])){
 
    temp_800KYr[i,2] <- reference_temp + as.numeric(temp_800KYr[i,2])
    
}

```


**Temp-Pages2k Data Set**

The temporal scale in this data set is structured in the desired format,
leaving the necessity of any additional conversion.

The temperature values, are presented as anomalies relative to the
reference period spanning from 1961 to 1990, expressed in degrees
Celsius. To align with the absolute reference value of 14°C (Quelle),
this constant value has been incrementally applied to each
data set record.

```{r}

# conversion to absolute temperature

# reference temperature from 1961-1990 is 14 degree Celsius

reference_temp <- 14

for (i in seq_along(temp_pages2k[,2])){
 
    temp_pages2k[i,2] <- reference_temp + as.numeric(temp_pages2k[i,2])
}

```


**Temp-NOAA-recent-Era Data Set**

Again, the temporal scale in this data set is structured in the desired
format. No further conversions had to be conducted.

The temperature values are displayed as anomalies. The absolute
reference temperature, derived from the period spanning from 1901 to
2000 quantified at 13.9°C (Quelle), has been summed with each data
record.

```{r}

# conversion to absolute temperature

# reference temperature from 1901-2000 is 13.9°C

reference_temp <- 13.9

for (i in seq_along(temp_NOAA_recentEra[,2])){
 
    temp_NOAA_recentEra[i,2] <- reference_temp + as.numeric(temp_NOAA_recentEra[i,2])
    
}

```


### Renaming of Variables


```{r, collapse=TRUE}

# co2 data

colnames(co2_ice_cores) <- c("year", "co2")

colnames(co2_mauna_loa)[2] <- "co2"

# temp data

colnames(temp_800KYr) <- c("year", "temp")

colnames(temp_pages2k) <- c("year", "temp")

colnames(temp_NOAA_recentEra) <- c("year", "temp")

```


## Construction of the CO2-timeline


In order to construct the co2-timeline out of the 2 provided data sets, the focus
has first been laid on the overlapping section. The plot below shows the 
overlapping period, where both, co2-ice-core and co2-mauna-loa, data are available.


```{r, warning = FALSE}

# plot of the two datasets

ggplot() +
  geom_line(data= co2_ice_cores, aes(x = year, y = co2, color = "Ice Cores"), size = 1) +
  geom_line(data = co2_mauna_loa, aes(x = year, y = co2, color = "Mauna Loa"), size = 1) +
  labs(title = "Overlapping Section of the co2-datasets",
       x = "Year",
       y = "CO2 Concentration in ppm") +
  scale_color_manual(values = c("Ice Cores" = "cornflowerblue", "Mauna Loa" = "coral"),
                     name = "Datasources") +
  xlim(1957, 2023) +
  ylim(300,425) +
  theme_minimal()

```


**Description:**

The two data sets have a relatively consistent correspondence. The co2-ice-cores 
data set contains stronger fluctuations. Also there are more data points lying 
below the co2-mauna-loa data set than above it. Around the year 1980, the 
co2-ice-cores data set consistently registers lower concentrations of carbon 
dioxide (CO2) in comparison to the co2-mauna-loa data set. Moreover, the two lines 
do not intersect anymore.


**Analysis:**

The illustration above provides a very good initial overview of the situation.

In contrast to the mauna-loa data set, the ice-cores data set lacks a consistent,
annual resolution. Within a single year, there may be 2-3 measurements or there 
are gaps extending over several years. During the overlapping period less ice-cores 
data is available. Furthermore, the data is derived from direct measurements and, 
unlike the mauna-loa data set, is not averaged. These two factors may explain 
the rougher curve observed in the ice-cores data set.

In order to be able to determine the further procedure for creating the time 
series, it should be seen whether the two data sets show a significant difference
regarding their CO2 values during the overlapping period.

To do this the mean over all data points of the overlapping period should be 
conducted for the two data sets.

Before doing so, the co2-ice-cores data set had to be brought to an annual 
resolution to compute the mean over the same amount of data points. Overall it 
was noticed, that the co2-ice-cores data set has data-gaps over 50 years, 
especially as the age gets older (around -100'000 years). 


```{r}

# check for gaps larger than 50 years
time_diff <- abs(diff(co2_ice_cores$year))
max_gap_allowed <- 50

# check if all differences are less than or equal to 10
no_large_gaps <- all(time_diff <= max_gap_allowed)

# print of the result
if (no_large_gaps) {
  cat("There are no larger gaps than", max_gap_allowed, "years.\n")
} else {
  cat("There are larger gaps than", max_gap_allowed, "years.\n")
}

```


A linear interpolation was conducted to gain the annual resolution of the 
co2-ice-cores dataset.


```{r}

# aggregate ice-cores data set to years

agg_ice_cores <- co2_ice_cores %>%
  group_by(year = as.numeric(substring(year, 1, regexpr("\\.", year)))) %>%
  summarize(co2 = mean(co2))

agg_ice_cores <- agg_ice_cores %>% arrange(desc(agg_ice_cores$year))
agg_ice_cores <- na.omit(agg_ice_cores)

# compute linear interpolation

interpolated_df <- data.frame(
  # sequence with annual resolution
  year = seq(min(agg_ice_cores$year, na.rm = TRUE), max(agg_ice_cores$year, na.rm = TRUE), by = 1)  
)

interpolated_df$co2 <- approx(x = agg_ice_cores$year, y = agg_ice_cores$co2, xout = interpolated_df$year)$y

```


The plot below now shows the interpolated co2-ice-cores data set together with 
the unchanged co2-mauna-loa data set. It can be seen that the co2-ice-cores curve 
is much smoother and therefore shows fewer strong fluctuations.


```{r, warning = FALSE}

# plot of the two datasets

ggplot() +
  geom_line(data= interpolated_df, aes(x = year, y = co2, color = "Ice Cores"), size = 1) +
  geom_line(data = co2_mauna_loa, aes(x = year, y = co2, color = "Mauna Loa"), size = 1) +
  labs(title = "CO2 Values Over Time",
       x = "Year",
       y = "CO2 Concentration in ppm") +
  scale_color_manual(values = c("Ice Cores" = "cornflowerblue", "Mauna Loa" = "coral"),
                     name = "Datasources") +
  xlim(1957, 2023) +
  ylim(300,425) +
  theme_minimal()

```


Finally, the mean of the overlap period of both data sets could be determined. 
They were then subtracted from each other and formed the so-called offset. The 
t-test was carried out to find out whether the difference between the two is 
significant.


```{r}

# subsets of the overlapping period of co2_ice_cores and co2_mauna_loa data sets

subset_mauna_loa <- co2_mauna_loa[co2_mauna_loa$year <= 2001,]

subset_ice_cores <- interpolated_df[interpolated_df$year >= 1958,]

# calculate the means of both subsets

mean_mauna_loa <- mean(subset_mauna_loa$co2)

mean_ice_cores <- mean(subset_ice_cores$co2)

# calculate the offset

offset <- mean_mauna_loa - mean_ice_cores

# make a t-test to see if means have a significant difference

t_test_result <- t.test(subset_mauna_loa$co2, subset_ice_cores$co2)

print(t_test_result)

```


The t-test was conducted to see if there is a significant difference between the
means of the two data sets. The null-hypothesis says in this case, that the two 
data-sets have no significant difference. The p-value is xxx lies within the 
acceptance region. The null-hypothesis must therefore be accepted and cannot be 
rejected. Consequently the two data sets show no significant difference during
the overlap period. Based on this result, the offset will not be added to the 
ice-core-data-set and no "correction" will be performed.


**Diskussion:**

To construct the final timeline no offset is applied to the co2-ice-cores data 
as already discussed. The interpolated values on the other hand are adopted.
Starting from the overlapping period, the co2-mauna-loa data set is chosen. 
This decision is motivated by the availability of more precise and up-to-date 
data, facilitated by direct measurements of atmospheric CO2 concentrations. 
Unlike ice-core extractions, which require a more complex process, measuring CO2 
directly from the atmosphere provides a more accurate representation of 
current conditions.


**The CO2-timeline**


```{r}

# plot

# select mauna-loa dataset

co2_timeline <- co2_mauna_loa

# add ice-core data from 1958 on

subset_interpolated_df <- interpolated_df[interpolated_df$year < 1958,]

subset_interpolated_df <- subset_interpolated_df %>% arrange(desc(subset_interpolated_df$year))

co2_timeline <- bind_rows(co2_timeline, subset_interpolated_df)


# plot

ggplot(data = co2_timeline) +
  geom_line(aes(x = year, y = co2), size = 1) +
  labs(title = "CO2 Values Over Time",
       x = "Year",
       y = "CO2 Concentration [ppm]") +
  scale_x_continuous(labels = label_comma()) + 
  theme_minimal()

```


## Further Analysis

-   änderungsraten analyse mit linear fit (Analyse: Werte interpolieren
    um mehr zu haben und schauen wie sich die Temperaturkurve
    verändert?)

```{r}

# Berechnung des linearen Trends
linear_model <- lm(co2 ~ year, data = interpolated_df)

# Regressionskoeffizienten für die Änderungsrate
rate_of_change_coefficient <- coef(linear_model)["year"]

# plot

ggplot(interpolated_df, aes(x = year, y = co2)) +
  geom_line() +
  labs(title = "CO2-Konzentration und Änderungsrate", x = "Jahr", y = "CO2 [ppm]") +
  geom_smooth(method = "lm", se = FALSE, color = "red")  # lineare Regression einfügen

```


# Results

Presentation Order:
Present the results in a logical order.
Start with the most basic and central findings.
Progress towards more nuanced details.
Visualizations:
Include clear and effective visualizations of the constructed timeline.
Use graphs, charts, or plots to enhance the presentation.
Key Findings:
Summarize the main outcomes derived from the constructed timeline.



```{r}


# Shiny app structure
ui <- fluidPage(
  sliderInput("time_range", "Select Time Range",
              min = min(co2_timeline$year),
              max = max(co2_timeline$year),
              value = c(min(co2_timeline$year), max(co2_timeline$year)),
              step = 10,
              ticks = TRUE,
              round = TRUE,),
  
  textInput("custom_range", "Enter Time Range (e.g., 2000,2010)", ""),
  
  plotOutput("co2_plot")
)

server <- function(input, output) {
  # Function to create a subset of data based on the slider and text input
  filtered_data <- reactive({
    min_year <- if (input$custom_range != "") as.numeric(strsplit(input$custom_range, ",")[[1]][1]) else input$time_range[1]
    max_year <- if (input$custom_range != "") as.numeric(strsplit(input$custom_range, ",")[[1]][2]) else input$time_range[2]

    subset(co2_timeline, year >= min_year & year <= max_year)
  })

  # Render the plot based on the filtered data
  output$co2_plot <- renderPlot({
    ggplot(data = filtered_data()) +
      geom_line(aes(x = year, y = co2), size = 1) +
      #geom_smooth(method = "lm", se = FALSE, color = "red")+  # add linear Rrgression 
      labs(title = "CO2 Timeline",
           x = "Year",
           y = "CO2 Concentration [ppm]") +
      scale_x_continuous(labels = scales::label_comma()) + 
      theme_minimal() +
      theme(plot.title = element_text(size = 20),
            plot.margin = margin(t = 10),
            axis.text.x = element_text(margin = margin(b = 10), face = "bold"),
            axis.text.y = element_text(face = "bold"))
  })
}

shinyApp(ui, server)

```












# References

Average temperature of 1901-2000
<https://www.ncei.noaa.gov/access/monitoring/monthly-report/global/202013#>:\~:text=The%201901%E2%80%932000%20average%20combined,C%20(60.9%C2%B0F).

The average temperature over the period 1960-1990 was 14°C
<https://www.un.org/sustainabledevelopment/blog/2016/01/wmo-confirms-2015-as-hottest-year-on-record/#>:\~:text=WMO%20uses%201961%2D1990%20as,period%20was%2014%C2%B0C.
